<div><script type="@plotdb/block">var condctrl,ref$;condctrl=function(i){i==null&&(i={});this._hash={};this._visibility={};this._fields=i.fields||{};this._list=i.conditions||[];this._applyBaseRule=i.baseRule||function(){};return this};condctrl.prototype=(ref$=Object.create(Object.prototype),ref$.isVisible=function(i){return this._visibility[i]},ref$.isEnabled=function(i){return this._visibility[i]},ref$.get=function(i){return this._hash[i]},ref$.subcond=function(i){var e,t,r,n,s,l,a,f,o=[];e=i.target,t=i.config,r=i.active;n=this._fields[e].itf;if(!(n&&n.ctrl&&(s=n.ctrl())&&(l=s.condctrl()))){return}for(a in l){f=l[a];f.apply(import$({active:r},t));o.push(f.run())}return o},ref$.init=function(i){var e,t,r,n,s,l,a,f=[],o=this;i==null&&(i={});this._fields=i.fields||this._fields||{};this._list=i.conditions||this._list||[];for(e in t=this._fields){r=t[e];if(!(r.meta||{}).condition){continue}this._list.splice(0,0,{src:e,config:r.meta.condition})}for(n=0,s=this._list.length;n<s;++n){l=n;a=this._list[l];if(!a.id){a.id=l+1+""}this._hash[a.id]=a;if(!Array.isArray(a.config)){a.config=[a.config]}f.push(a.config.map(c))}return f;function c(r){var t,n;if(r.enabled){r.disabled=false}else if(r.enabled!=null){r.disabled=true}r.source=a.src;r.func=a.func;return r.targets=Array.from(new Set((r.prefix?r.prefix:[]).concat(r.targets||[],function(){var i,e=[];for(t in i=this._fields){n=i[t];e.push({k:t,v:n})}return e}.call(o).filter(function(i){var e,t;e=i.k,t=i.v;return(!r.prefix?0:r.prefix.filter(function(i){return e.startsWith(i)}).length)+(t.meta.tag||[]).filter(function(i){return in$(i,r.tags||[])}).length>0}).map(function(i){return i.k}))))}},ref$.apply=function(i){var e,t,r,n,s,l,a,f,o;i==null&&(i={});e=i.target,t=i.active,r=i.enabled,n=i.disabled,s=i.isRequired,l=i.readonly;if(n!=null){this._visibility[e]=!!(!n!==!t&&(n||t))}if(this._fields[e]&&(a=this._fields[e].itf)){f=a.serialize();o=JSON.parse(JSON.stringify(f));if(n!=null){o.disabled=!(!n!==!t&&(n||t))}if(l!=null){o.readonly=!(!l!==!t&&(l||t))}if(s!=null){o.isRequired=!(!s!==!t&&(s||t))}this._applyBaseRule({target:e,widget:a,meta:o,opt:i});if(!!f.disabled===!!o.disabled&&!!f.isRequired===!!o.isRequired&&!!f.readonly===!!o.readonly){return}a.deserialize(o,{init:true})}if(!(Array.isArray(e)&&e[1])){return}return this.subcond({target:e[0],config:{target:config.target.slice(1),enabled:r,disabled:n,isRequired:s,readonly:l},active:t})},ref$._run=function(i,e){var t,r,n,s,l,a,f,o,c,u,d,h,g,p,y,b;i==null&&(i={});t=i.source,r=i.values,n=i.targets,s=i.isRequired,l=i.enabled,a=i.disabled,f=i.readonly,o=i.func;if(o){c=true;for(u=0,d=n.length;u<d;++u){h=n[u];g=!!o.apply(this,[(p=import$({},i),p.target=h,p)])&&!(e!=null&&!e);c=c&&g;if(Array.isArray(h)&&h[1]){this.subcond({target:h[0],config:(p=import$({},i),p.target=h.slice(1),p),active:g});continue}this.apply({target:h,enabled:l,active:g,disabled:a,isRequired:s,readonly:f})}}else{if(!(this._fields[t]&&(y=this._fields[t].itf))){console.error("[nest/condctrl] try to execute a condition with nonexisted fields '"+t+"'");return}b=y.content();b=Array.isArray(b)?b:[b];g=!!b.filter(function(i){if(Array.isArray(r)){return in$(i,r)}else{return i===r}}).length;if(e!=null&&!e){g=false}for(u=0,d=n.length;u<d;++u){h=n[u];if(Array.isArray(h)&&h[1]){this.subcond({target:h[0],config:(p=import$({},i),p.target=h.slice(1),p),active:g});continue}this.apply({target:h,enabled:l,active:g,disabled:a,isRequired:s,readonly:f})}c=g}return c},ref$.run=function(){var u,d,h=this;u={};d=function(){var i,e,t,r,n,s,l,a,f,o,c=[];if(h.list){console.error("[@makeform/nest] access `condctrl.list` is deprecated.");console.error("[@makeform/nest] set `conditions` when contructing or initing instead.")}if(!arguments.length){i=h.list||h._list}else{i=Array.from(arguments)}for(e=0,t=i.length;e<t;++e){r=e;n=[];s=i[r];if(u[s.id]!=null){continue}if(s.precond&&h._hash[s.precond]){d(h._hash[s.precond])}for(l=0,f=(a=s.config).length;l<f;++l){o=a[l];n.push(u[s.id]=h._run(o,u[s.precond]))}c.push(n)}return c};return d()},ref$);function import$(i,e){var t={}.hasOwnProperty;for(var r in e)if(t.call(e,r))i[r]=e[r];return i}function in$(i,e){var t=-1,r=e.length>>>0;while(++t<r)if(i===e[t])return true;return false}var mod;module.exports={pkg:{extend:{name:"@makeform/common"},dependencies:[{name:"proxise"},{name:"ldview"},{name:"@plotdb/form"}]},init:function(n){return n.pubsub.fire("subinit",{mod:mod(n)})}};mod=function(n){var a,e,r,t,i,f,l,o,c,k,w,d,u;a=n.root,e=n.ctx,r=n.data,t=n.parent,i=n.t,f=n.i18n,l=n.manager,o=n.pubsub;c=e.ldview,k=e.form;w={host:{},data:{list:[],object:{}},fields:null,entry:{},subcond:function(n){var e,t,r,i;e=n.field,t=n.key;if(!t){return function(){var n,e=[];for(r in n=this.entry){i=n[r];e.push(i.subcond)}return e}.call(this).filter(function(n){return n})}}};d=function(n){var e;if(!(n&&n.adapt)){return}return n.adapt((e=import$({},w.host),e.upload=function(n){var e,t,r;e=n.file,t=n.progress,r=n.alias;return w.host.upload({file:e,progress:t,alias:r||name})},e))};u=function(e){e==null&&(e={});w.fields=e.fields||{};w.conditions=e.conditions;w.onchange=e.onchange;w.validate=e.validate;w.instance=e.instance;w.autofill=e.autofill;w.adapt=e.adapt;w.doctree=e.doctree;w.composing=e.composing;w.mode=e.mode||"list";w.display=e.display||"all";w.viewcfg=e.view||{};return Promise.resolve().then(function(){return w.init()}).then(function(n){if(e.init){return e.init.apply(w._ctx,[w])}})};o.on("@makeform/nest:init",u);o.on("init.nest",u);return{init:function(){var u,p,t,n,b=this;u={same:function(){return this.internal},renew:function(){return this.internal=true},clear:function(){return this.internal=false}};p={meta:{},readonlys:{},readonly:undefined};t=function(n,e){var t,r,i,o,a,u,f,l,c,d,s,m=[];n==null&&(n={});e==null&&(e={});p.meta=JSON.parse(JSON.stringify(n));if(p.readonly===p.meta.readonly){return}p.readonly=!!p.meta.readonly;for(t in r=w.entry){i=r[t];o=[];for(a in u=i.fields){f=u[a];if(!(l=i.block[a].cfg.itf)){continue}if((p.readonlys[t]||{})[a]==null){((c=p.readonlys)[t]||(c[t]={}))[a]=!!f.meta.readonly}d=p.readonly?p.readonly:p.readonlys[t][a];s=l.serialize();if(s.readonly===d){continue}s.readonly=d;o.push(l.deserialize(s,e))}m.push(o)}return m};this.on("meta",function(n,e){return t(b.serialize(),e)});t(r);this.on("mode",function(n){var e,t,r,i=[];for(e in t=w.entry){r=t[e];i.push(r.formmgr.mode(n))}return i});this.on("change",function(n){var e,t,r,i,o,a;n==null&&(n={});if(u.same(n)){return u.clear()}w.data=n;if(w.mode==="list"){(e=w.data).list||(e.list=[]);t=Object.fromEntries(w.data.list.map(function(n){return[n.key,true]}));if(!w.activeKey){w.activeKey=(w.data.list[0]||{}).key}for(r in e=w.entry){i=e[r];if(!t[r]){delete w.entry[r]}}w.view.render();return w.data.list.map(function(t){var n,r,i;if(!w.entry[t.key]){return}n=function(){var n,e=[];for(r in n=w.entry[t.key].block||{}){i=n[r];e.push(i)}return e}().map(function(n){return n.init()});return Promise.all(n).then(function(){return w.entry[t.key].formmgr.value(t.value)}).then(function(){if(w.onchange){return w.onchange({formmgr:w.entry[t.key].formmgr})}})})}else{(e=w.data).object||(e.object={});o=undefined;a=function(){var n,e=[];for(r in n=w.entry[o].block||{}){i=n[r];e.push(i)}return e}().map(function(n){return n.init()});return Promise.all(a).then(function(){return w.entry[o].formmgr.value(w.data.object)}).then(function(){if(w.onchange){return w.onchange({formmgr:w.entry[o].formmgr})}})}});n=function(n){var h,e,v,t,r,i,o;h=function(){var n,e;u.renew();n=w.mode==="list"?{list:(e=w.data).list,sig:e.sig}:{object:(e=w.data).object,sig:e.sig};if(!n.sig){delete n.sig}return b.value(n)};e={add:function(){var n;if(p.readonly){return}n=w.data.list;n.push({value:{},key:Math.random().toString(36).substring(2),idx:n.length+1});h();w.view.render();if(w.instance&&w.instance.transform){return w.instance.transform("i18n")}},delete:function(n){var e,t,r,i;e=n.node,t=n.ctx,r=n.ctxs;if(p.readonly){return}i=w.data.list;i.splice(i.indexOf(t),1);i.map(function(n,e){return n.idx=e+1});delete w.entry[t.key];h();return w.view.render()}};v={init:function(n){var t,r,i,o,a,e;t=n.node,r=n.entry,i=n.name,o=n.bobj,a=n.cfg;if(!a){try{if(!w.fields[i]||!(a=JSON.parse(JSON.stringify(w.fields[i])))){throw new Error("config not found for field "+i)}}catch(n){e=n;console.warn("exception when parsing block data for field name `"+i+"`.");throw e}}if(!a.meta.title){a.meta.title=i}r.block[i]={cfg:a,path:i,inited:false,init:proxise(function(){if(this.inited){return Promise.resolve()}})};t.classList.toggle("d-none",true);if(p.readonly){a.meta.readonly=true}return Promise.resolve().then(function(){var n,e;if(o){return n=(a.root=t,a),n.itf=o.itf,n.bi=o.bi,n}e=typeof a.type==="object"?a.type:typeof a.type==="string"?{name:a.type,version:"main"}:{name:"@makeform/input",version:"main"};return l.from(e,{root:t,data:a.meta}).then(function(n){var e;a.itf=n["interface"];a.bi=n.instance;a.root=t;return e=r.fields[i],e.itf=n["interface"],e.bi=n.instance,e.root=t,e})}).then(function(){var n,e;n=a.itf;if(p.readonly){a.meta.readonly=true}n.deserialize(a.meta,{init:true});d(n);r.formmgr.add({widget:n,path:i});n.mode(r.formmgr.mode());r.block[i].inited=true;r.block[i].init.resolve(true);if(n.manager().length){b.fire("manager.changed")}n.on("manager.changed",function(){return b.fire("manager.changed")});n.on("meta",function(){return b.fire("meta",b.serialize())});if(!(n.ctrl&&(e=n.ctrl())&&e.condctrl)){return}return r.subcond=e.condctrl})["catch"](function(n){return Promise.reject(n)})},handler:function(n){var e,t,r,i,o,a;e=n.node,t=n.name,r=n.ctx;i=(((w.entry[r.key]||{}).block||{})[t]||{}).cfg||{};o=(((w.entry[r.key]||{}).cond||{})._visibility||{})[t];e.classList.toggle("d-none",o!=null&&!o);if(!i.itf){return}if((a=w.entry[r.key].dirty)&&a.size){if(a.has(t)){a["delete"](t)}return}if(i.lng!==f.language){i.bi.transform("i18n");i.lng=f.language;return i.itf.render()}}};t={add:function(n){var e,t;e=n.node,t=n.ctx;return e.style.display=b.mode()==="view"||p.readonly?"none":""},"no-entry":function(n){var e;e=n.node;return e.classList.toggle("d-none",b.content().length)},entry:{init:{"@":function(n){var y,e,g,t;y=n.ctx,e=n.node,g=n.views;t=function(n){var e,t,r,i,o,a,u,f,l,c,d,s,m;n==null&&(n={});e=[];w.docroot=n.host;w.entry[y.key]={fields:{},doctree:r,block:{},formmgr:t=new k.manager,cond:new condctrl({baseRule:function(n){var e;e=n.meta;if(p.readonly){return e.readonly=true}}})};if(w.docroot){r=w.docroot.nodemgr().blocks();i=w.entry[y.key];for(o=0,a=r.length;o<a;++o){u=r[o];f=u.node.id;l=w.docroot.nodemgr().getDom({id:f});c=u.block["interface"].serialize();e.push(v.init({entry:i,name:f,cfg:{meta:c},node:l,bobj:{itf:u.block["interface"],bi:u.block.instance}}))}}else{for(d in s=w.fields){m=s[d];w.entry[y.key].fields[d]=import$({},m)}}return Promise.all(e).then(function(){w.entry[y.key].cond.init({fields:w.entry[y.key].fields,conditions:w.conditions||[]});return t.value(y.value,{init:true}).then(function(){t.mode(b.mode());debounce(350).then(function(){if(!w.entry[y.key]){return}w.entry[y.key].cond.run();return g[0].render()});t.on("change",function(n){var e;if(!w.entry[y.key]){return}w.entry[y.key].cond.run();if(!w.entry[y.key].dirty){w.entry[y.key].dirty=new Set}if(n&&n.path){w.entry[y.key].dirty.add(n.path)}g[0].render();if(w.mode==="list"){if(!(e=w.data.list.filter(function(n){return n.key===y.key})[0])){return}e.value=JSON.parse(JSON.stringify(t.value()))}else{w.data.object=JSON.parse(JSON.stringify(t.value()))||{}}return h()});b.fire("manager.changed");if(w.instance&&w.instance.transform){return w.instance.transform("i18n")}})})};if(!(w.doctree&&!w.composing)){return t()}else{return w.doctree({root:e.querySelector("[ld=docroot]")||e}).then(t)}},block:function(n){var e,t,r,i,o;e=n.node,t=n.ctxs,r=n.ctx;i=w.entry[r.key];o=e.dataset.name;return v.init({node:e,entry:i,name:o})}},handler:{delete:function(n){var e,t;e=n.node,t=n.ctx;return e.style.display=b.mode()==="view"||p.readonly?"none":""},"@":function(n){var e,t,r,i,o,a,u,f,l,c,d=[];e=n.node,t=n.ctx;if(w.display==="active"){e.classList.toggle("d-none",t.key!==w.activeKey)}if(!w.doctree||w.composing){return}if(!((r=w.docroot)&&r.nodemgr)){return}i=r?r.nodemgr().blocks():null;o=w.entry[t.key];for(a=0,u=i.length;a<u;++a){f=i[a];l=f.node.id;c=r.nodemgr().getDom({id:l});d.push(v.handler({node:c,name:l,ctx:t}))}return d},lng:function(n){var e;e=n.node;return e.classList.toggle("d-none",!(f.language.startsWith(e.dataset.lng)||f.language.startsWith(e.dataset.lng+"-")))},visibility:function(n){var e,t,r,i;e=n.node,t=n.ctx;r=e.getAttribute("data-name");e.classList.toggle("d-none",false);i=(((w.entry[t.key]||{}).cond||{})._visibility||{})[r];return e.classList.toggle("d-none",i!=null&&!i)},autofill:function(n){var e,t,r,i,o;e=n.node,t=n.views,r=n.ctx;i=e.dataset.name;o=(((w.entry[r.key]||{}).block||{})[i]||{}).cfg||{};if(o&&o.itf){if(!o.autofill){o.itf.on("change",o.autofill=function(){return t[0].render("autofill")})}return e.textContent=o.itf.content()}else if(b.autofill!=null){return e.textContent=b.autofill({name:i})}},block:function(n){var e,t,r,i;e=n.node,t=n.ctxs,r=n.ctx;i=e.getAttribute("data-name");return v.handler({node:e,name:i,ctx:r})}}}};r=(i=import$({},n.common||{}),i.initRender=false,i.root=a,i.ctx=function(){return w.data.object||{}},i);if(w.mode==="list"){((i=r.action||(r.action={})).click||(i.click={})).add=e.add;(r.handler||(r.handler={}))["no-entry"]=t["no-entry"];(r.handler||(r.handler={})).add=t.add;(r.handler||(r.handler={})).entry={list:function(){return w.data.list||[]},key:function(n){return n.key},view:import$({},n.entry||{})};o=r.handler.entry.view;((i=o.action||(o.action={})).click||(i.click={}))["delete"]=e["delete"];import$(o.init||(o.init={}),t.entry.init);import$(o.handler||(o.handler={}),t.entry.handler)}else{import$(r.init||(r.init={}),t.entry.init);import$(r.handler||(r.handler={}),t.entry.handler)}return r};w.init=proxise.once(function(){if(w.inited){return}w._ctx=b;w.inited=true;if(!w.fields){return}w.view=new c(n(w.viewcfg));return w.view.init().then(function(){f.on("languageChanged",function(){return w.view.render("lng")});w.view.render();return b})});return w.init()},render:function(){if(w.view){return w.view.render()}},isEqual:function(n,e){return JSON.stringify(n)===JSON.stringify(e)},isEmpty:function(n){if(w.mode==="list"){return!n||JSON.stringify(n)==="{}"||!n.list||!n.list.length}return!n||JSON.stringify(n)==="{}"},content:function(){if(w.mode==="list"){return w.data.list}else{return w.data.object}},validate:function(u){var n,t,r;u==null&&(u={});n=function(){var n,e=[];for(t in n=w.entry||{}){r=n[t];e.push(r)}return e}().map(function(a){var t,r;return Promise.all(function(){var n,e=[];for(t in n=a.block){r=n[t];e.push(r)}return e}().map(function(){return r.init()})).then(function(n){var e,t,r,i,o;e=n.filter(function(n){return n}).length||u.init;t=function(){var n,e=[];for(r in n=a.block){i=n[r];e.push(i)}return e}().filter(function(n){return!n.cfg.itf.disabled()});o=t.filter(function(n){return n.cfg.itf&&(!n.cfg.itf.isEmpty()||n.cfg.itf.isEmpty()&&!n.cfg.itf.isRequired()||n.cfg.itf.status()===2)&&!n.cfg.itf.disabled()}).map(function(n){return{widget:n.cfg.itf,path:n.path}});if(!o.length&&!u.force){a.status=1;return a}o=u.force?null:o;return a.formmgr.check(o,{now:true,init:e,force:u.force}).then(function(n){a.status=n.length?2:e||o&&o.length<t.length?1:(o||[]).filter(function(n){return n.widget.status()===3}).length?3:0;return a})})});return Promise.all(n).then(function(n){var t;t=[0,0,0,0];n.forEach(function(n){return t[n.status]++});if(t[2]){return["nested"]}return Promise.resolve().then(function(){if(!w.validate){return}return w.validate(u,w)}).then(function(n){var e;if(e=n){return e}if(t[1]||t[3]){return{status:3,errors:[]}}return[]})})},adapt:function(n){var e,t,r,i,o,a,u,f=[];w.host=n;if(w.adapt){w.adapt(n)}for(e in t=w.entry){r=t[e];i=[];for(o in a=r.fields){u=a[o];if(u.itf){i.push(d(u.itf))}}f.push(i)}return f},manager:function(n){var e,t,r,i,o,a,u,f,l,c=this;e=(t=(n!=null?n:{}).depth)!=null?t:0;r=function(){var n,e=[];for(i in n=w.entry||{}){o=n[i];e.push(o)}return e}().map(function(n){return n.formmgr}).filter(function(n){return n});r.map(function(n){return n.disable(!!c.disabled())});if(e===1){return r}for(i in t=w.entry){o=t[i];for(a in u=o.block){f=u[a];if(f.cfg.itf&&(l=f.cfg.itf.manager({depth:e-1})).length){r=r.concat(l)}}}if(this.disabled()){r.map(function(n){return n.disable(true)})}return r},ctrl:function(){return{toggle:function(n){n==null&&(n={});if(n.key){w.activeKey=n.key}return w.view.render()},condctrl:function(){var t,r;return Object.fromEntries(function(){var n,e=[];for(t in n=w.entry){r=n[t];e.push([t,r.cond])}return e}())}}}}};function import$(n,e){var t={}.hasOwnProperty;for(var r in e)if(t.call(e,r))n[r]=e[r];return n}</script></div>
