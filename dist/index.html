<div><script type="@plotdb/block">var mod;module.exports={pkg:{extend:{name:"@makeform/common"},dependencies:[{name:"ldview"},{name:"@plotdb/form"}]},init:function(n){return n.pubsub.fire("subinit",{mod:mod(n)})}};mod=function(n){var u,t,e,r,i,f,o,c,l,s;u=n.root,t=n.ctx,e=n.data,r=n.parent,i=n.t,f=n.manager,o=n.pubsub;c=t.ldview,l=t.form;s={data:{list:[],object:{}},fields:null,entry:{}};o.on("init.nest",function(n){var t,e,r,i,o,a;t=n.mode,e=n.fields,r=n.view,i=n.onchange,o=n.validate,a=n.instance;s.mode=t||"list";s.fields=e;s.viewcfg=r;s.onchange=i;s.validate=o;s.instance=a;if(s.init){return s.init()}});return{init:function(){var n,a=this;this.on("mode",function(n){var t,e,r,i=[];for(t in e=s.entry){r=e[t];i.push(r.formmgr.mode(n))}return i});this.on("change",function(n){var t,e,r,i,o,a;n==null&&(n={});s.data=n||{};if(s.mode==="list"){(t=s.data).list||(t.list=[]);e=s.data.list.map(function(n){return n.key});for(r in t=s.entry){i=t[r];if(!in$(r,e)){delete s.entry[r]}}s.view.render();return s.data.list.map(function(e){var n,r,i;if(!s.entry[e.key]){return}n=function(){var n,t=[];for(r in n=s.entry[e.key].block||{}){i=n[r];t.push(i)}return t}().map(function(n){return n.init()});return Promise.all(n).then(function(){return s.entry[e.key].formmgr.value(e.value)}).then(function(){if(s.onchange){return s.onchange({formmgr:s.entry[e.key].formmgr})}})})}else{o=undefined;a=function(){var n,t=[];for(r in n=s.entry[o].block||{}){i=n[r];t.push(i)}return t}().map(function(n){return n.init()});return Promise.all(a).then(function(){return s.entry[o].formmgr.value(s.data.object)}).then(function(){if(s.onchange){return s.onchange({formmgr:s.entry[o].formmgr})}})}});n=function(n){var o,t,e,r,i;o=function(){return a.value(s.mode==="list"?{list:s.data.list}:{object:s.data.object})};t={add:function(){var n;n=s.data.list;n.push({value:{},key:Math.random().toString(36).substring(2),idx:n.length+1});o();s.view.render();if(s.instance&&s.instance.transform){return s.instance.transform("i18n")}},delete:function(n){var t,e,r,i;t=n.node,e=n.ctx,r=n.ctxs;i=s.data.list;i.splice(i.indexOf(e),1);i.map(function(n,t){return n.idx=t+1});delete s.entry[e.key];o();return s.view.render()},"no-entry":function(n){var t;t=n.node;return t.classList.toggle("d-none",a.content().length)},entry:{init:{"@":function(n){var t,e;t=n.ctx;s.entry[t.key]={block:{},formmgr:e=new l.manager};e.mode(a.mode());return e.on("change",function(){var n;if(s.mode==="list"){if(!(n=s.data.list.filter(function(n){return n.key===t.key})[0])){return}n.value=JSON.parse(JSON.stringify(e.value()))}else{s.data.object=JSON.parse(JSON.stringify(e.value()))}return o()})},block:function(n){var e,t,r,i,o,a,u;e=n.node,t=n.ctxs,r=n.ctx;i=s.entry[r.key];o=e.getAttribute("data-name");if(!(a=JSON.parse(JSON.stringify(s.fields[o])))){return console.warn("config not found for field "+o)}if(!a.meta.title){a.meta.title=o}i.block[o]={cfg:a,path:o,inited:false,init:proxise(function(){if(this.inited){return Promise.resolve()}})};e.classList.toggle("d-none",true);u=typeof a.type==="object"?a.type:typeof a.type==="string"?{name:a.type,version:"main"}:{name:"@makeform/input",version:"main"};return f.from(u,{root:e,data:a.meta}).then(function(n){var t;a.itf=n["interface"];a.bi=n.instance;a.root=e;n["interface"].adapt((t=import$({},s.host),t.upload=function(n){var t,e,r;t=n.file,e=n.progress,r=n.alias;return s.host.upload({file:t,progress:e,alias:r||o})},t));i.formmgr.add({widget:a.itf,path:o});a.itf.mode(i.formmgr.mode());i.block[o].inited=true;return i.block[o].init.resolve(true)})["catch"](function(n){return Promise.reject(n)})}},handler:{block:function(n){var t,e,r,i,o;t=n.node,e=n.ctxs,r=n.ctx;i=t.getAttribute("data-name");o=(((s.entry[r.key]||{}).block||{})[i]||{}).cfg||{};t.classList.toggle("d-none",false);if(!o.itf){return}o.bi.transform("i18n");return o.itf.render()}}}};e=(r=import$({},n.common||{}),r.initRender=false,r.root=u,r.ctx=function(){return s.data.object},r);if(s.mode==="list"){((r=e.action||(e.action={})).click||(r.click={})).add=t.add;(e.handler||(e.handler={}))["no-entry"]=t["no-entry"];(e.handler||(e.handler={})).entry={list:function(){return s.data.list||[]},key:function(n){return n.key},view:import$({},n.entry||{})};i=e.handler.entry.view;((r=i.action||(i.action={})).click||(r.click={}))["delete"]=t["delete"];import$(i.init||(i.init={}),t.entry.init);import$(i.handler||(i.handler={}),t.entry.handler)}else{import$(e.init||(e.init={}),t.entry.init);import$(e.handler||(e.handler={}),t.entry.handler)}return e};s.init=function(){if(!s.fields){return}s.view=new c(n(s.viewcfg));return s.view.render()};return s.init()},render:function(){if(s.view){return s.view.render()}},isEqual:function(n,t){return JSON.stringify(n)===JSON.stringify(t)},isEmpty:function(n){if(s.mode==="list"){return!n||JSON.stringify(n)==="{}"||!n.list||!n.list.length}return!n||JSON.stringify(n)==="{}"},content:function(){if(s.mode==="list"){return s.data.list}else{return s.data.object}},validate:function(c){var n,e,r;c==null&&(c={});n=function(){var n,t=[];for(e in n=s.entry||{}){r=n[e];t.push(r)}return t}().map(function(f){var e,r;return Promise.all(function(){var n,t=[];for(e in n=f.block){r=n[e];t.push(r)}return t}().map(function(){return r.init()})).then(function(n){var t,e,r,i,o,a,u;t=n.filter(function(n){return n}).length||c.init;r=[];for(i in o=f.block){a=o[i];r.push(a)}e=r;u=e.filter(function(n){return n.cfg.itf&&(!n.cfg.itf.isEmpty()||n.cfg.itf.status()===2)}).map(function(n){return{widget:n.cfg.itf,path:n.path}});if(!u.length&&!c.force){f.status=1;return f}u=c.force?null:u;return f.formmgr.check(u,{now:true,init:t}).then(function(n){f.status=n.length?2:t||u&&u.length<e.length?1:0;return f})})});return Promise.all(n).then(function(n){var e;e=[0,0,0];n.forEach(function(n){return e[n.status]++});if(e[2]){return["nested"]}return Promise.resolve().then(function(){if(!s.validate){return}return s.validate(c,s)}).then(function(n){var t;if(t=n){return t}if(e[1]){return{status:3,errors:[]}}return[]})})},adapt:function(n){return s.host=n},manager:function(){var e,r;return function(){var n,t=[];for(e in n=s.entry||{}){r=n[e];t.push(r)}return t}().map(function(n){return n.formmgr}).filter(function(n){return n})}}};function in$(n,t){var e=-1,r=t.length>>>0;while(++e<r)if(n===t[e])return true;return false}function import$(n,t){var e={}.hasOwnProperty;for(var r in t)if(e.call(t,r))n[r]=t[r];return n}</script></div>
