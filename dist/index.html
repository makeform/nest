<div><script type="@plotdb/block">var condctrl,ref$;condctrl=function(i){i==null&&(i={});this._hash={};this._visibility={};this._fields=i.fields||{};this.list=i.conditions||[];return this};condctrl.prototype=(ref$=Object.create(Object.prototype),ref$.isVisible=function(i){return this._visibility[i]},ref$.isEnabled=function(i){return this._visibility[i]},ref$.get=function(i){return this._hash[i]},ref$.subcond=function(i){var e,r,t,n,s,l,a,f,o=[];e=i.target,r=i.config,t=i.active;n=this._fields[e].itf;if(!(n&&n.ctrl&&(s=n.ctrl())&&(l=s.condctrl()))){return}for(a in l){f=l[a];f.apply(import$({active:t},r));o.push(f.run())}return o},ref$.init=function(i){var e,r,t,n,s,l,a,f=[],o=this;i==null&&(i={});this._fields=i.fields||this._fields||{};for(e in r=this._fields){t=r[e];if(!t.meta.condition){continue}this.list.splice(0,0,{src:e,config:t.meta.condition})}for(n=0,s=this.list.length;n<s;++n){l=n;a=this.list[l];if(!a.id){a.id=l+1+""}this._hash[a.id]=a;if(!Array.isArray(a.config)){a.config=[a.config]}f.push(a.config.map(u))}return f;function u(t){var r,n;if(t.enabled){t.disabled=false}else if(t.enabled!=null){t.disabled=true}t.source=a.src;t.func=a.func;return t.targets=Array.from(new Set((t.prefix?t.prefix:[]).concat(t.targets||[],function(){var i,e=[];for(r in i=this._fields){n=i[r];e.push({k:r,v:n})}return e}.call(o).filter(function(i){var e,r;e=i.k,r=i.v;return(!t.prefix?0:t.prefix.filter(function(i){return e.startsWith(i)}).length)+(r.meta.tag||[]).filter(function(i){return in$(i,t.tags||[])}).length>0}).map(function(i){return i.k}))))}},ref$.apply=function(i){var e,r,t,n,s,l,a,f,o;i==null&&(i={});e=i.target,r=i.active,t=i.enabled,n=i.disabled,s=i.isRequired,l=i.readonly;if(n!=null){this._visibility[e]=!!(!n!==!r&&(n||r))}if(this._fields[e]&&(a=this._fields[e].itf)){f=a.serialize();o=JSON.parse(JSON.stringify(f));if(n!=null){o.disabled=!(!n!==!r&&(n||r))}if(l!=null){o.readonly=!(!l!==!r&&(l||r))}if(s!=null){o.isRequired=!(!s!==!r&&(s||r))}if(!!f.disabled===!!o.disabled&&!!f.isRequired===!!o.isRequired&&!!f.readonly===!!o.readonly){return}a.deserialize(o,{init:true})}if(!(Array.isArray(e)&&e[1])){return}return this.subcond({target:e[0],config:{target:config.target.slice(1),enabled:t,disabled:n,isRequired:s,readonly:l},active:r})},ref$._run=function(i,e){var r,t,n,s,l,a,f,o,u,c,d,h,g,p,y,b;i==null&&(i={});r=i.source,t=i.values,n=i.targets,s=i.isRequired,l=i.enabled,a=i.disabled,f=i.readonly,o=i.func;if(o){u=true;for(c=0,d=n.length;c<d;++c){h=n[c];g=!!o.apply(this,[(p=import$({},i),p.target=h,p)])&&!(e!=null&&!e);u=u&&g;if(Array.isArray(h)&&h[1]){this.subcond({target:h[0],config:(p=import$({},i),p.target=h.slice(1),p),active:g});continue}this.apply({target:h,enabled:l,active:g,disabled:a,isRequired:s,readonly:f})}}else{if(!(this._fields[r]&&(y=this._fields[r].itf))){console.error("[nest/condctrl] try to execute a condition with nonexisted fields '"+r+"'");return}b=y.content();b=Array.isArray(b)?b:[b];g=!!b.filter(function(i){if(Array.isArray(t)){return in$(i,t)}else{return i===t}}).length;if(e!=null&&!e){g=false}for(c=0,d=n.length;c<d;++c){h=n[c];if(Array.isArray(h)&&h[1]){this.subcond({target:h[0],config:(p=import$({},i),p.target=h.slice(1),p),active:g});continue}this.apply({target:h,enabled:l,active:g,disabled:a,isRequired:s,readonly:f})}u=g}return u},ref$.run=function(){var c,d,h=this;c={};d=function(){var i,e,r,t,n,s,l,a,f,o,u=[];if(!arguments.length){i=h.list}else{i=Array.from(arguments)}for(e=0,r=i.length;e<r;++e){t=e;n=[];s=i[t];if(c[s.id]!=null){continue}if(s.precond&&h._hash[s.precond]){d(h._hash[s.precond])}for(l=0,f=(a=s.config).length;l<f;++l){o=a[l];n.push(c[s.id]=h._run(o,c[s.precond]))}u.push(n)}return u};return d()},ref$);function import$(i,e){var r={}.hasOwnProperty;for(var t in e)if(r.call(e,t))i[t]=e[t];return i}function in$(i,e){var r=-1,t=e.length>>>0;while(++r<t)if(i===e[r])return true;return false}var mod;module.exports={pkg:{extend:{name:"@makeform/common"},dependencies:[{name:"proxise"},{name:"ldview"},{name:"@plotdb/form"}]},init:function(n){return n.pubsub.fire("subinit",{mod:mod(n)})}};mod=function(n){var a,t,e,r,i,u,s,o,d,m,g,y;a=n.root,t=n.ctx,e=n.data,r=n.parent,i=n.t,u=n.i18n,s=n.manager,o=n.pubsub;d=t.ldview,m=t.form;g={host:{},data:{list:[],object:{}},fields:null,entry:{},subcond:function(n){var t,e,r,i;t=n.field,e=n.key;if(!e){return function(){var n,t=[];for(r in n=this.entry){i=n[r];t.push(i.subcond)}return t}.call(this).filter(function(n){return n})}}};y=function(n){var t;if(!(n&&n.adapt)){return}return n.adapt((t=import$({},g.host),t.upload=function(n){var t,e,r;t=n.file,e=n.progress,r=n.alias;return g.host.upload({file:t,progress:e,alias:r||name})},t))};o.on("init.nest",function(t){t==null&&(t={});g.fields=t.fields;g.conditions=t.conditions;g.onchange=t.onchange;g.validate=t.validate;g.instance=t.instance;g.autofill=t.autofill;g.adapt=t.adapt;g.mode=t.mode||"list";g.display=t.display||"all";g.viewcfg=t.view||{};return Promise.resolve().then(function(){return g.init()}).then(function(n){if(t.init){return t.init.apply(g._ctx,[g])}})});return{init:function(){var f,o,l,t,n,c=this;f=function(n){var t;t=((g.data||{}).sig||{}).token;return t&&(n.sig||{}).token===t};o=function(){var n,t;n=(t=g.data).sig||(t.sig={});n.count=n.count||0;n.ts=Date.now();return n.token=Math.random().toString(36).substring(2)+"-"+n.ts+"-"+n.count};l={meta:{},readonlys:{},readonly:undefined};t=function(n){var t,e,r,i,o,a,f,u,c=[];l.meta=n;if(l.readonly===!!l.meta.readonly){return}l.readonly=!!l.meta.readonly;for(t in e=g.entry){r=e[t];i=[];for(o in a=r.fields){f=a[o];if((l.readonlys[t]||{})[o]==null){((u=l.readonlys)[t]||(u[t]={}))[o]=!!f.meta.readonly}f.meta.readonly=l.meta.readonly?l.meta.readonly:l.readonlys[t][o];if(f.itf){i.push(f.itf.deserialize(f.meta))}}c.push(i)}return c};this.on("meta",function(n){return t(c.serialize())});t(e);this.on("mode",function(n){var t,e,r,i=[];for(t in e=g.entry){r=e[t];i.push(r.formmgr.mode(n))}return i});this.on("change",function(n){var t,e,r,i,o,a;n==null&&(n={});if(f(n)){return}g.data=n;if(g.mode==="list"){(t=g.data).list||(t.list=[]);e=g.data.list.map(function(n){return n.key});if(!g.activeKey){g.activeKey=e[0]}for(r in t=g.entry){i=t[r];if(!in$(r,e)){delete g.entry[r]}}g.view.render();return g.data.list.map(function(e){var n,r,i;if(!g.entry[e.key]){return}n=function(){var n,t=[];for(r in n=g.entry[e.key].block||{}){i=n[r];t.push(i)}return t}().map(function(n){return n.init()});return Promise.all(n).then(function(){return g.entry[e.key].formmgr.value(e.value)}).then(function(){if(g.onchange){return g.onchange({formmgr:g.entry[e.key].formmgr})}})})}else{(t=g.data).object||(t.object={});o=undefined;a=function(){var n,t=[];for(r in n=g.entry[o].block||{}){i=n[r];t.push(i)}return t}().map(function(n){return n.init()});return Promise.all(a).then(function(){return g.entry[o].formmgr.value(g.data.object)}).then(function(){if(g.onchange){return g.onchange({formmgr:g.entry[o].formmgr})}})}});n=function(n){var f,t,e,r,i;f=function(){var n;o();return c.value(g.mode==="list"?{list:(n=g.data).list,sig:n.sig}:{object:(n=g.data).object,sig:n.sig})};t={add:function(){var n;n=g.data.list;n.push({value:{},key:Math.random().toString(36).substring(2),idx:n.length+1});f();g.view.render();if(g.instance&&g.instance.transform){return g.instance.transform("i18n")}},delete:function(n){var t,e,r,i;t=n.node,e=n.ctx,r=n.ctxs;i=g.data.list;i.splice(i.indexOf(e),1);i.map(function(n,t){return n.idx=t+1});delete g.entry[e.key];f();return g.view.render()},"no-entry":function(n){var t;t=n.node;return t.classList.toggle("d-none",c.content().length)},entry:{init:{"@":function(n){var t,e,r,i,o,a;t=n.ctx,e=n.views;g.entry[t.key]={fields:{},block:{},formmgr:r=new m.manager,cond:new condctrl};for(i in o=g.fields){a=o[i];g.entry[t.key].fields[i]=import$({},a)}g.entry[t.key].cond.list=g.conditions||[];g.entry[t.key].cond.init({fields:g.entry[t.key].fields});r.mode(c.mode());debounce(350).then(function(){if(!g.entry[t.key]){return}g.entry[t.key].cond.run();return e[0].render()});r.on("change",function(){var n;if(!g.entry[t.key]){return}g.entry[t.key].cond.run();e[0].render();if(g.mode==="list"){if(!(n=g.data.list.filter(function(n){return n.key===t.key})[0])){return}n.value=JSON.parse(JSON.stringify(r.value()))}else{g.data.object=JSON.parse(JSON.stringify(r.value()))||{}}return f()});c.fire("manager.changed");if(g.instance&&g.instance.transform){return g.instance.transform("i18n")}},block:function(n){var r,t,e,i,o,a,f,u;r=n.node,t=n.ctxs,e=n.ctx;i=g.entry[e.key];o=r.dataset.name;try{if(!g.fields[o]||!(a=JSON.parse(JSON.stringify(g.fields[o])))){throw new Error("config not found for field "+o)}}catch(n){f=n;console.warn("exception when parsing block data for field name `"+o+"`.");throw f}if(!a.meta.title){a.meta.title=o}i.block[o]={cfg:a,path:o,inited:false,init:proxise(function(){if(this.inited){return Promise.resolve()}})};r.classList.toggle("d-none",true);u=typeof a.type==="object"?a.type:typeof a.type==="string"?{name:a.type,version:"main"}:{name:"@makeform/input",version:"main"};return s.from(u,{root:r,data:a.meta}).then(function(n){var t,e;a.itf=n["interface"];a.bi=n.instance;a.root=r;t=i.fields[o];t.itf=n["interface"];t.bi=n.instance;t.root=r;y(n["interface"]);i.formmgr.add({widget:a.itf,path:o});a.itf.mode(i.formmgr.mode());i.block[o].inited=true;i.block[o].init.resolve(true);if(n["interface"].manager().length){c.fire("manager.changed")}n["interface"].on("manager.changed",function(){return c.fire("manager.changed")});if(!(n["interface"].ctrl&&(e=n["interface"].ctrl())&&e.condctrl)){return}return i.subcond=e.condctrl})["catch"](function(n){return Promise.reject(n)})}},handler:{"@":function(n){var t,e;t=n.node,e=n.ctx;if(g.display!=="active"){return}return t.classList.toggle("d-none",e.key!==g.activeKey)},lng:function(n){var t;t=n.node;return t.classList.toggle("d-none",!(u.language.startsWith(t.dataset.lng)||u.language.startsWith(t.dataset.lng+"-")))},visibility:function(n){var t,e,r,i;t=n.node,e=n.ctx;r=t.getAttribute("data-name");t.classList.toggle("d-none",false);i=(g.entry[e.key]||{}).cond._visibility[r];return t.classList.toggle("d-none",i!=null&&!i)},autofill:function(n){var t,e,r,i,o;t=n.node,e=n.views,r=n.ctx;i=t.dataset.name;o=(((g.entry[r.key]||{}).block||{})[i]||{}).cfg||{};if(o&&o.itf){if(!o.autofill){o.itf.on("change",o.autofill=function(){return e[0].render("autofill")})}return t.textContent=o.itf.content()}else if(c.autofill!=null){return t.textContent=c.autofill({name:i})}},block:function(n){var t,e,r,i,o,a;t=n.node,e=n.ctxs,r=n.ctx;i=t.getAttribute("data-name");o=(((g.entry[r.key]||{}).block||{})[i]||{}).cfg||{};t.classList.toggle("d-none",false);a=(g.entry[r.key]||{}).cond._visibility[i];t.classList.toggle("d-none",a!=null&&!a);if(!o.itf){return}o.bi.transform("i18n");return o.itf.render()}}}};e=(r=import$({},n.common||{}),r.initRender=false,r.root=a,r.ctx=function(){return g.data.object||{}},r);if(g.mode==="list"){((r=e.action||(e.action={})).click||(r.click={})).add=t.add;(e.handler||(e.handler={}))["no-entry"]=t["no-entry"];(e.handler||(e.handler={})).entry={list:function(){return g.data.list||[]},key:function(n){return n.key},view:import$({},n.entry||{})};i=e.handler.entry.view;((r=i.action||(i.action={})).click||(r.click={}))["delete"]=t["delete"];import$(i.init||(i.init={}),t.entry.init);import$(i.handler||(i.handler={}),t.entry.handler)}else{import$(e.init||(e.init={}),t.entry.init);import$(e.handler||(e.handler={}),t.entry.handler)}return e};g.init=proxise.once(function(){if(g.inited){return}g._ctx=c;g.inited=true;if(!g.fields){return}g.view=new d(n(g.viewcfg));return g.view.init().then(function(){u.on("languageChanged",function(){return g.view.render("lng")});g.view.render();return c})});return g.init()},render:function(){if(g.view){return g.view.render()}},isEqual:function(n,t){return JSON.stringify(n)===JSON.stringify(t)},isEmpty:function(n){if(g.mode==="list"){return!n||JSON.stringify(n)==="{}"||!n.list||!n.list.length}return!n||JSON.stringify(n)==="{}"},content:function(){if(g.mode==="list"){return g.data.list}else{return g.data.object}},validate:function(c){var n,e,r;c==null&&(c={});n=function(){var n,t=[];for(e in n=g.entry||{}){r=n[e];t.push(r)}return t}().map(function(u){var e,r;return Promise.all(function(){var n,t=[];for(e in n=u.block){r=n[e];t.push(r)}return t}().map(function(){return r.init()})).then(function(n){var t,e,r,i,o,a,f;t=n.filter(function(n){return n}).length||c.init;r=[];for(i in o=u.block){a=o[i];r.push(a)}e=r;f=e.filter(function(n){return n.cfg.itf&&(!n.cfg.itf.isEmpty()||n.cfg.itf.status()===2)&&!n.cfg.itf.disabled()}).map(function(n){return{widget:n.cfg.itf,path:n.path}});if(!f.length&&!c.force){u.status=1;return u}f=c.force?null:f;return u.formmgr.check(f,{now:true,init:t,force:c.force}).then(function(n){u.status=n.length?2:t||f&&f.length<e.length?1:(f||[]).filter(function(n){return n.widget.status()===3}).length?3:0;return u})})});return Promise.all(n).then(function(n){var e;e=[0,0,0,0];n.forEach(function(n){return e[n.status]++});if(e[2]){return["nested"]}return Promise.resolve().then(function(){if(!g.validate){return}return g.validate(c,g)}).then(function(n){var t;if(t=n){return t}if(e[1]||e[3]){return{status:3,errors:[]}}return[]})})},adapt:function(n){var t,e,r,i,o,a,f,u=[];g.host=n;if(g.adapt){g.adapt(n)}for(t in e=g.entry){r=e[t];i=[];for(o in a=r.fields){f=a[o];if(f.itf){i.push(y(f.itf))}}u.push(i)}return u},manager:function(n){var t,e,r,i,o,a,f,u;t=function(){var n,t=[];for(e in n=g.entry||{}){r=n[e];t.push(r)}return t}().map(function(n){return n.formmgr}).filter(function(n){return n});for(e in i=g.entry){r=i[e];for(o in a=r.block){f=a[o];if(f.cfg.itf&&(u=f.cfg.itf.manager()).length){t=t.concat(u)}}}return t},ctrl:function(){return{toggle:function(n){n==null&&(n={});if(n.key){g.activeKey=n.key}return g.view.render()},condctrl:function(){var e,r;return Object.fromEntries(function(){var n,t=[];for(e in n=g.entry){r=n[e];t.push([e,r.cond])}return t}())}}}}};function import$(n,t){var e={}.hasOwnProperty;for(var r in t)if(e.call(t,r))n[r]=t[r];return n}function in$(n,t){var e=-1,r=t.length>>>0;while(++e<r)if(n===t[e])return true;return false}</script></div>
