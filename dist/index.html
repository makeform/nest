<div><script type="@plotdb/block">var mod;module.exports={pkg:{extend:{name:"@makeform/common"},dependencies:[{name:"ldview"},{name:"@plotdb/form"}]},init:function(t){return t.pubsub.fire("subinit",{mod:mod(t)})}};mod=function(t){var u,n,e,r,i,f,o,c,l,s;u=t.root,n=t.ctx,e=t.data,r=t.parent,i=t.t,f=t.manager,o=t.pubsub;c=n.ldview,l=n.form;s={data:{list:[],object:{}},fields:null,entry:{}};o.on("init.nest",function(t){var n,e,r,i;n=t.mode,e=t.fields,r=t.view,i=t.onchange;s.mode=n||"list";s.fields=e;s.viewcfg=r;s.onchange=i;if(s.init){return s.init()}});return{init:function(){var t,a=this;this.on("mode",function(t){var n,e,r,i=[];for(n in e=s.entry){r=e[n];i.push(r.formmgr.mode(t))}return i});this.on("change",function(t){var n,e,r,i,o,a;t==null&&(t={});s.data=t||{};if(s.mode==="list"){(n=s.data).list||(n.list=[]);e=s.data.list.map(function(t){return t.key});for(r in n=s.entry){i=n[r];if(!in$(r,e)){delete s.entry[r]}}s.view.render();return s.data.list.map(function(e){var t,r,i;if(!s.entry[e.key]){return}t=function(){var t,n=[];for(r in t=s.entry[e.key].block||{}){i=t[r];n.push(i)}return n}().map(function(t){return t.init()});return Promise.all(t).then(function(){return s.entry[e.key].formmgr.value(e.value)}).then(function(){if(s.onchange){return s.onchange({formmgr:s.entry[e.key].formmgr})}})})}else{o=undefined;a=function(){var t,n=[];for(r in t=s.entry[o].block||{}){i=t[r];n.push(i)}return n}().map(function(t){return t.init()});return Promise.all(a).then(function(){return s.entry[o].formmgr.value(s.data.object)}).then(function(){if(s.onchange){return s.onchange({formmgr:s.entry[o].formmgr})}})}});t=function(t){var o,n,e,r,i;o=function(){return a.value(s.mode==="list"?{list:s.data.list}:{object:s.data.object})};n={add:function(){var t;t=s.data.list;t.push({value:{},key:Math.random().toString(36).substring(2),idx:t.length+1});o();return s.view.render()},delete:function(t){var n,e,r,i;n=t.node,e=t.ctx,r=t.ctxs;i=s.data.list;i.splice(i.indexOf(e),1);i.map(function(t,n){return t.idx=n+1});delete s.entry[e.key];o();return s.view.render()},"no-entry":function(t){var n;n=t.node;return n.classList.toggle("d-none",a.content().length)},entry:{init:{"@":function(t){var n,e;n=t.ctx;s.entry[n.key]={block:{},formmgr:e=new l.manager};e.mode(a.mode());return e.on("change",function(){var t;if(s.mode==="list"){if(!(t=s.data.list.filter(function(t){return t.key===n.key})[0])){return}t.value=JSON.parse(JSON.stringify(e.value()))}else{s.data.object=JSON.parse(JSON.stringify(e.value()))}return o()})},block:function(t){var e,n,r,i,o,a,u;e=t.node,n=t.ctxs,r=t.ctx;i=s.entry[r.key];o=e.getAttribute("data-name");if(!(a=JSON.parse(JSON.stringify(s.fields[o])))){return console.warn("config not found for field "+o)}if(!a.meta.title){a.meta.title=o}i.block[o]={cfg:a,path:o,inited:false,init:proxise(function(){if(this.inited){return Promise.resolve()}})};e.classList.toggle("d-none",true);u=typeof a.type==="object"?a.type:typeof a.type==="string"?{name:a.type,version:"main"}:{name:"@makeform/input",version:"main"};return f.from(u,{root:e,data:a.meta}).then(function(t){var n;a.itf=t["interface"];a.bi=t.instance;a.root=e;t["interface"].adapt((n=import$({},s.host),n.upload=function(t){var n,e,r;n=t.file,e=t.progress,r=t.alias;return s.host.upload({file:n,progress:e,alias:r||o})},n));i.formmgr.add({widget:a.itf,path:o});a.itf.mode(i.formmgr.mode());i.block[o].inited=true;return i.block[o].init.resolve(true)})["catch"](function(t){return Promise.reject(t)})}},handler:{block:function(t){var n,e,r,i,o;n=t.node,e=t.ctxs,r=t.ctx;i=n.getAttribute("data-name");o=(((s.entry[r.key]||{}).block||{})[i]||{}).cfg||{};n.classList.toggle("d-none",false);if(!o.itf){return}o.bi.transform("i18n");return o.itf.render()}}}};e=(r=import$({},t.common||{}),r.initRender=false,r.root=u,r.ctx=function(){return s.data.object},r);if(s.mode==="list"){((r=e.action||(e.action={})).click||(r.click={})).add=n.add;(e.handler||(e.handler={}))["no-entry"]=n["no-entry"];(e.handler||(e.handler={})).entry={list:function(){return s.data.list||[]},key:function(t){return t.key},view:import$({},t.entry||{})};i=e.handler.entry.view;((r=i.action||(i.action={})).click||(r.click={}))["delete"]=n["delete"];import$(i.init||(i.init={}),n.entry.init);import$(i.handler||(i.handler={}),n.entry.handler)}else{import$(e.init||(e.init={}),n.entry.init);import$(e.handler||(e.handler={}),n.entry.handler)}return e};s.init=function(){if(!s.fields){return}s.view=new c(t(s.viewcfg));return s.view.render()};return s.init()},render:function(){if(s.view){return s.view.render()}},isEqual:function(t,n){return JSON.stringify(t)===JSON.stringify(n)},isEmpty:function(t){if(s.mode==="list"){return!t||JSON.stringify(t)==="{}"||!t.list||!t.list.length}return!t||JSON.stringify(t)==="{}"},content:function(){if(s.mode==="list"){return s.data.list}else{return s.data.object}},validate:function(c){var t,e,r;c==null&&(c={});t=function(){var t,n=[];for(e in t=s.entry||{}){r=t[e];n.push(r)}return n}().map(function(f){var e,r;return Promise.all(function(){var t,n=[];for(e in t=f.block){r=t[e];n.push(r)}return n}().map(function(){return r.init()})).then(function(t){var n,e,r,i,o,a,u;n=t.filter(function(t){return t}).length||c.init;r=[];for(i in o=f.block){a=o[i];r.push(a)}e=r;u=e.filter(function(t){return t.cfg.itf&&(!t.cfg.itf.isEmpty()||t.cfg.itf.status()===2)}).map(function(t){return{widget:t.cfg.itf,path:t.path}});if(!u.length&&!c.force){f.status=1;return f}u=c.force?null:u;return f.formmgr.check(u,{now:true,init:n}).then(function(t){f.status=t.length?2:n||u&&u.length<e.length?1:0;return f})})});return Promise.all(t).then(function(t){var n;n=[0,0,0];t.forEach(function(t){return n[t.status]++});if(n[2]){return["nested"]}if(n[1]){return{status:3,errors:[]}}return[]})},adapt:function(t){return s.host=t},manager:function(){var e,r;return function(){var t,n=[];for(e in t=s.entry||{}){r=t[e];n.push(r)}return n}().map(function(t){return t.formmgr}).filter(function(t){return t})}}};function in$(t,n){var e=-1,r=n.length>>>0;while(++e<r)if(t===n[e])return true;return false}function import$(t,n){var e={}.hasOwnProperty;for(var r in n)if(e.call(n,r))t[r]=n[r];return t}</script></div>
