<div><script type="@plotdb/block">var condctrl,ref$;condctrl=function(i){i==null&&(i={});this._hash={};this._visibility={};this._fields=i.fields||{};this.list=i.conditions||[];return this};condctrl.prototype=(ref$=Object.create(Object.prototype),ref$.get=function(i){return this._hash[i]},ref$.init=function(i){var e,r,t,n,s,l,f,u=[],d=this;i==null&&(i={});this._fields=i.fields||this._fields||{};for(e in r=this._fields){t=r[e];if(!t.meta.condition){continue}this.list.splice(0,0,{src:e,config:t.meta.condition})}for(n=0,s=this.list.length;n<s;++n){l=n;f=this.list[l];if(!f.id){f.id=l+1+""}this._hash[f.id]=f;if(!Array.isArray(f.config)){f.config=[f.config]}u.push(f.config.map(o))}return u;function o(t){var i,r,n;i=t.isRequired!=null&&!t.isRequired?false:true;if(t.enabled){t.disabled=false;t.isRequired=i}else if(t.enabled!=null){t.disabled=true;t.isRequired=!i}t.source=f.src;return t.targets=Array.from(new Set((t.prefix?t.prefix:[]).concat(t.targets||[],function(){var i,e=[];for(r in i=this._fields){n=i[r];e.push({k:r,v:n})}return e}.call(d).filter(function(i){var e,r;e=i.k,r=i.v;return(!t.prefix?0:t.prefix.filter(function(i){return e.startsWith(i)}).length)+(r.meta.tag||[]).filter(function(i){return in$(i,t.tags||[])}).length>0}).map(function(i){return i.k}))))}},ref$.apply=function(i){var e,r,t,n,s,l,f;i==null&&(i={});e=i.widget,r=i.active,t=i.disabled,n=i.isRequired,s=i.readonly;l=e.serialize();f=JSON.parse(JSON.stringify(l));if(t!=null){f.disabled=!(!t!==!r&&(t||r))}if(s!=null){f.readonly=!(!s!==!r&&(s||r))}if(n!=null){f.isRequired=!(!n!==!r&&(n||r))}if(!!l.disabled===!!f.disabled&&!!l.isRequired===!!f.isRequired&&!!l.readonly===!!f.readonly){return}return e.deserialize(f,{init:true})},ref$._run=function(i,e){var r,t,n,s,l,f,u,d,o,a,c,h,g;r=i.source,t=i.values,n=i.targets,s=i.isRequired,l=i.disabled,f=i.readonly;if(!(this._fields[r]&&(u=this._fields[r].itf))){console.error("[nest/condctrl] try to execute a condition with nonexisted fields '"+r+"'");return}d=u.content();d=Array.isArray(d)?d:[d];o=!!d.filter(function(i){if(Array.isArray(t)){return in$(i,t)}else{return i===t}}).length;if(e!=null&&!e){o=false}for(a=0,c=n.length;a<c;++a){h=n[a];if(l!=null){this._visibility[h]=!!(!l!==!o&&(l||o))}if(!(this._fields[h]&&(g=this._fields[h].itf))){continue}this.apply({widget:g,active:o,disabled:l,isRequired:s,readonly:f})}return o},ref$.run=function(){var a,c,h=this;a={};c=function(){var i,e,r,t,n,s,l,f,u,d,o=[];if(!arguments.length){i=h.list}else{i=Array.from(arguments)}for(e=0,r=i.length;e<r;++e){t=e;n=[];s=i[t];if(a[s.id]!=null){continue}if(s.precond&&h._hash[s.precond]){c(h._hash[s.precond])}for(l=0,u=(f=s.config).length;l<u;++l){d=f[l];n.push(a[s.id]=h._run(d,a[s.precond]))}o.push(n)}return o};return c()},ref$);function in$(i,e){var r=-1,t=e.length>>>0;while(++r<t)if(i===e[r])return true;return false}var mod;module.exports={pkg:{extend:{name:"@makeform/common"},dependencies:[{name:"proxise"},{name:"ldview"},{name:"@plotdb/form"}]},init:function(n){return n.pubsub.fire("subinit",{mod:mod(n)})}};mod=function(n){var o,t,e,r,i,a,l,f,u,s,d;o=n.root,t=n.ctx,e=n.data,r=n.parent,i=n.t,a=n.i18n,l=n.manager,f=n.pubsub;u=t.ldview,s=t.form;d={data:{list:[],object:{}},fields:null,entry:{}};f.on("init.nest",function(n){var t,e,r,i,o,a,f,u,c;t=n.init,e=n.mode,r=n.display,i=n.fields,o=n.conditions,a=n.view,f=n.onchange,u=n.validate,c=n.instance;d.mode=e||"list";d.display=r||"all";d.fields=i;d.conditions=o;d.viewcfg=a||{};d.onchange=f;d.validate=u;d.instance=c;return Promise.resolve().then(function(){if(d.init){return d.init()}}).then(function(){if(t){return t(d)}})});return{init:function(){var n,c=this;this.on("mode",function(n){var t,e,r,i=[];for(t in e=d.entry){r=e[t];i.push(r.formmgr.mode(n))}return i});this.on("change",function(n){var t,e,r,i,o,a;n==null&&(n={});d.data=n||{};if(d.mode==="list"){(t=d.data).list||(t.list=[]);e=d.data.list.map(function(n){return n.key});if(!d.activeKey){d.activeKey=e[0]}for(r in t=d.entry){i=t[r];if(!in$(r,e)){delete d.entry[r]}}d.view.render();return d.data.list.map(function(e){var n,r,i;if(!d.entry[e.key]){return}n=function(){var n,t=[];for(r in n=d.entry[e.key].block||{}){i=n[r];t.push(i)}return t}().map(function(n){return n.init()});return Promise.all(n).then(function(){return d.entry[e.key].formmgr.value(e.value)}).then(function(){if(d.onchange){return d.onchange({formmgr:d.entry[e.key].formmgr})}})})}else{o=undefined;a=function(){var n,t=[];for(r in n=d.entry[o].block||{}){i=n[r];t.push(i)}return t}().map(function(n){return n.init()});return Promise.all(a).then(function(){return d.entry[o].formmgr.value(d.data.object)}).then(function(){if(d.onchange){return d.onchange({formmgr:d.entry[o].formmgr})}})}});n=function(n){var f,t,e,r,i;f=function(){return c.value(d.mode==="list"?{list:d.data.list}:{object:d.data.object})};t={add:function(){var n;n=d.data.list;n.push({value:{},key:Math.random().toString(36).substring(2),idx:n.length+1});f();d.view.render();if(d.instance&&d.instance.transform){return d.instance.transform("i18n")}},delete:function(n){var t,e,r,i;t=n.node,e=n.ctx,r=n.ctxs;i=d.data.list;i.splice(i.indexOf(e),1);i.map(function(n,t){return n.idx=t+1});delete d.entry[e.key];f();return d.view.render()},"no-entry":function(n){var t;t=n.node;return t.classList.toggle("d-none",c.content().length)},entry:{init:{"@":function(n){var t,e,r,i,o,a;t=n.ctx,e=n.views;d.entry[t.key]={fields:{},block:{},formmgr:r=new s.manager,cond:new condctrl};for(i in o=d.fields){a=o[i];d.entry[t.key].fields[i]=import$({},a)}d.entry[t.key].cond.list=d.conditions||[];d.entry[t.key].cond.init({fields:d.entry[t.key].fields});r.mode(c.mode());debounce(350).then(function(){if(!d.entry[t.key]){return}d.entry[t.key].cond.run();return e[0].render()});r.on("change",function(){var n;if(!d.entry[t.key]){return}d.entry[t.key].cond.run();e[0].render();if(d.mode==="list"){if(!(n=d.data.list.filter(function(n){return n.key===t.key})[0])){return}n.value=JSON.parse(JSON.stringify(r.value()))}else{d.data.object=JSON.parse(JSON.stringify(r.value()))}return f()});c.fire("manager.changed");if(d.instance&&d.instance.transform){return d.instance.transform("i18n")}},block:function(n){var e,t,r,i,o,a,f,u;e=n.node,t=n.ctxs,r=n.ctx;i=d.entry[r.key];o=e.dataset.name;try{if(!d.fields[o]||!(a=JSON.parse(JSON.stringify(d.fields[o])))){throw new Error("config not found for field "+o)}}catch(n){f=n;console.warn("exception when parsing block data for field name `"+o+"`.");throw f}if(!a.meta.title){a.meta.title=o}i.block[o]={cfg:a,path:o,inited:false,init:proxise(function(){if(this.inited){return Promise.resolve()}})};e.classList.toggle("d-none",true);u=typeof a.type==="object"?a.type:typeof a.type==="string"?{name:a.type,version:"main"}:{name:"@makeform/input",version:"main"};return l.from(u,{root:e,data:a.meta}).then(function(n){var t;a.itf=n["interface"];a.bi=n.instance;a.root=e;t=i.fields[o];t.itf=n["interface"];t.bi=n.instance;t.root=e;n["interface"].adapt((t=import$({},d.host),t.upload=function(n){var t,e,r;t=n.file,e=n.progress,r=n.alias;return d.host.upload({file:t,progress:e,alias:r||o})},t));i.formmgr.add({widget:a.itf,path:o});a.itf.mode(i.formmgr.mode());i.block[o].inited=true;i.block[o].init.resolve(true);if(n["interface"].manager().length){c.fire("manager.changed")}return n["interface"].on("manager.changed",function(){return c.fire("manager.changed")})})["catch"](function(n){return Promise.reject(n)})}},handler:{"@":function(n){var t,e;t=n.node,e=n.ctx;if(d.display!=="active"){return}return t.classList.toggle("d-none",e.key!==d.activeKey)},lng:function(n){var t;t=n.node;return t.classList.toggle("d-none",!(a.language.startsWith(t.dataset.lng)||a.language.startsWith(t.dataset.lng+"-")))},visibility:function(n){var t,e,r,i;t=n.node,e=n.ctx;r=t.getAttribute("data-name");t.classList.toggle("d-none",false);i=(d.entry[e.key]||{}).cond._visibility[r];return t.classList.toggle("d-none",i!=null&&!i)},block:function(n){var t,e,r,i,o,a;t=n.node,e=n.ctxs,r=n.ctx;i=t.getAttribute("data-name");o=(((d.entry[r.key]||{}).block||{})[i]||{}).cfg||{};t.classList.toggle("d-none",false);a=(d.entry[r.key]||{}).cond._visibility[i];t.classList.toggle("d-none",a!=null&&!a);if(!o.itf){return}o.bi.transform("i18n");return o.itf.render()}}}};e=(r=import$({},n.common||{}),r.initRender=false,r.root=o,r.ctx=function(){return d.data.object},r);if(d.mode==="list"){((r=e.action||(e.action={})).click||(r.click={})).add=t.add;(e.handler||(e.handler={}))["no-entry"]=t["no-entry"];(e.handler||(e.handler={})).entry={list:function(){return d.data.list||[]},key:function(n){return n.key},view:import$({},n.entry||{})};i=e.handler.entry.view;((r=i.action||(i.action={})).click||(r.click={}))["delete"]=t["delete"];import$(i.init||(i.init={}),t.entry.init);import$(i.handler||(i.handler={}),t.entry.handler)}else{import$(e.init||(e.init={}),t.entry.init);import$(e.handler||(e.handler={}),t.entry.handler)}return e};d.init=proxise.once(function(){if(d.inited){return}d.inited=true;if(!d.fields){return}d.view=new u(n(d.viewcfg));return d.view.init().then(function(){a.on("languageChanged",function(){return d.view.render("lng")});return d.view.render()})});return d.init()},render:function(){if(d.view){return d.view.render()}},isEqual:function(n,t){return JSON.stringify(n)===JSON.stringify(t)},isEmpty:function(n){if(d.mode==="list"){return!n||JSON.stringify(n)==="{}"||!n.list||!n.list.length}return!n||JSON.stringify(n)==="{}"},content:function(){if(d.mode==="list"){return d.data.list}else{return d.data.object}},validate:function(c){var n,e,r;c==null&&(c={});n=function(){var n,t=[];for(e in n=d.entry||{}){r=n[e];t.push(r)}return t}().map(function(u){var e,r;return Promise.all(function(){var n,t=[];for(e in n=u.block){r=n[e];t.push(r)}return t}().map(function(){return r.init()})).then(function(n){var t,e,r,i,o,a,f;t=n.filter(function(n){return n}).length||c.init;r=[];for(i in o=u.block){a=o[i];r.push(a)}e=r;f=e.filter(function(n){return n.cfg.itf&&(!n.cfg.itf.isEmpty()||n.cfg.itf.status()===2)&&!n.cfg.itf.disabled()}).map(function(n){return{widget:n.cfg.itf,path:n.path}});if(!f.length&&!c.force){u.status=1;return u}f=c.force?null:f;return u.formmgr.check(f,{now:true,init:t,force:c.force}).then(function(n){u.status=n.length?2:t||f&&f.length<e.length?1:0;return u})})});return Promise.all(n).then(function(n){var e;e=[0,0,0];n.forEach(function(n){return e[n.status]++});if(e[2]){return["nested"]}return Promise.resolve().then(function(){if(!d.validate){return}return d.validate(c,d)}).then(function(n){var t;if(t=n){return t}if(e[1]){return{status:3,errors:[]}}return[]})})},adapt:function(n){return d.host=n},manager:function(n){var t,e,r,i,o,a,f,u;t=function(){var n,t=[];for(e in n=d.entry||{}){r=n[e];t.push(r)}return t}().map(function(n){return n.formmgr}).filter(function(n){return n});for(e in i=d.entry){r=i[e];for(o in a=r.block){f=a[o];if(f.cfg.itf&&(u=f.cfg.itf.manager()).length){t=t.concat(u)}}}return t},ctrl:function(){return{toggle:function(n){n==null&&(n={});if(n.key){d.activeKey=n.key}return d.view.render()}}}}};function in$(n,t){var e=-1,r=t.length>>>0;while(++e<r)if(n===t[e])return true;return false}function import$(n,t){var e={}.hasOwnProperty;for(var r in t)if(e.call(t,r))n[r]=t[r];return n}</script></div>
