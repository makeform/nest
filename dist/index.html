<div><script type="@plotdb/block">var condctrl,ref$;condctrl=function(i){i==null&&(i={});this._hash={};this._visibility={};this._fields=i.fields||{};this.list=i.conditions||[];return this};condctrl.prototype=(ref$=Object.create(Object.prototype),ref$.get=function(i){return this._hash[i]},ref$.init=function(i){var e,r,t,n,s,l,f,u=[],d=this;i==null&&(i={});this._fields=i.fields||this._fields||{};for(e in r=this._fields){t=r[e];if(!t.meta.condition){continue}this.list.splice(0,0,{src:e,config:t.meta.condition})}for(n=0,s=this.list.length;n<s;++n){l=n;f=this.list[l];if(!f.id){f.id=l+1+""}this._hash[f.id]=f;if(!Array.isArray(f.config)){f.config=[f.config]}u.push(f.config.map(o))}return u;function o(t){var i,r,n;i=t.isRequired!=null&&!t.isRequired?false:true;if(t.enabled){t.disabled=false;t.isRequired=i}else if(t.enabled!=null){t.disabled=true;t.isRequired=!i}t.source=f.src;return t.targets=Array.from(new Set((t.prefix?t.prefix:[]).concat(t.targets||[],function(){var i,e=[];for(r in i=this._fields){n=i[r];e.push({k:r,v:n})}return e}.call(d).filter(function(i){var e,r;e=i.k,r=i.v;return(!t.prefix?0:t.prefix.filter(function(i){return e.startsWith(i)}).length)+(r.meta.tag||[]).filter(function(i){return in$(i,t.tags||[])}).length>0}).map(function(i){return i.k}))))}},ref$.apply=function(i){var e,r,t,n,s,l,f;i==null&&(i={});e=i.widget,r=i.active,t=i.disabled,n=i.isRequired,s=i.readonly;l=e.serialize();f=JSON.parse(JSON.stringify(l));if(t!=null){f.disabled=!(!t!==!r&&(t||r))}if(s!=null){f.readonly=!(!s!==!r&&(s||r))}if(n!=null){f.isRequired=!(!n!==!r&&(n||r))}if(!!l.disabled===!!f.disabled&&!!l.isRequired===!!f.isRequired&&!!l.readonly===!!f.readonly){return}return e.deserialize(f,{init:true})},ref$._run=function(i,e){var r,t,n,s,l,f,u,d,o,a,c,h,g;r=i.source,t=i.values,n=i.targets,s=i.isRequired,l=i.disabled,f=i.readonly;if(!(this._fields[r]&&(u=this._fields[r].itf))){console.error("[nest/condctrl] try to execute a condition with nonexisted fields '"+r+"'");return}d=u.content();d=Array.isArray(d)?d:[d];o=!!d.filter(function(i){if(Array.isArray(t)){return in$(i,t)}else{return i===t}}).length;if(e!=null&&!e){o=false}for(a=0,c=n.length;a<c;++a){h=n[a];if(l!=null){this._visibility[h]=!!(!l!==!o&&(l||o))}if(!(this._fields[h]&&(g=this._fields[h].itf))){continue}this.apply({widget:g,active:o,disabled:l,isRequired:s,readonly:f})}return o},ref$.run=function(){var a,c,h=this;a={};c=function(){var i,e,r,t,n,s,l,f,u,d,o=[];if(!arguments.length){i=h.list}else{i=Array.from(arguments)}for(e=0,r=i.length;e<r;++e){t=e;n=[];s=i[t];if(a[s.id]!=null){continue}if(s.precond&&h._hash[s.precond]){c(h._hash[s.precond])}for(l=0,u=(f=s.config).length;l<u;++l){d=f[l];n.push(a[s.id]=h._run(d,a[s.precond]))}o.push(n)}return o};return c()},ref$);function in$(i,e){var r=-1,t=e.length>>>0;while(++r<t)if(i===e[r])return true;return false}var mod;console.log("blah");module.exports={pkg:{extend:{name:"@makeform/common"},dependencies:[{name:"proxise"},{name:"ldview"},{name:"@plotdb/form"}]},init:function(n){return n.pubsub.fire("subinit",{mod:mod(n)})}};mod=function(n){var o,t,e,r,i,l,a,f,c,s;o=n.root,t=n.ctx,e=n.data,r=n.parent,i=n.t,l=n.manager,a=n.pubsub;f=t.ldview,c=t.form;s={data:{list:[],object:{}},fields:null,entry:{}};a.on("init.nest",function(n){var t,e,r,i,o,a,f,c,u;t=n.init,e=n.mode,r=n.display,i=n.fields,o=n.conditions,a=n.view,f=n.onchange,c=n.validate,u=n.instance;s.mode=e||"list";s.display=r||"all";s.fields=i;s.conditions=o;s.viewcfg=a||{};s.onchange=f;s.validate=c;s.instance=u;return Promise.resolve().then(function(){if(s.init){return s.init()}}).then(function(){if(t){return t(s)}})});return{init:function(){var n,u=this;this.on("mode",function(n){var t,e,r,i=[];for(t in e=s.entry){r=e[t];i.push(r.formmgr.mode(n))}return i});this.on("change",function(n){var t,e,r,i,o,a;n==null&&(n={});s.data=n||{};if(s.mode==="list"){(t=s.data).list||(t.list=[]);e=s.data.list.map(function(n){return n.key});if(!s.activeKey){s.activeKey=e[0]}for(r in t=s.entry){i=t[r];if(!in$(r,e)){delete s.entry[r]}}s.view.render();return s.data.list.map(function(e){var n,r,i;if(!s.entry[e.key]){return}n=function(){var n,t=[];for(r in n=s.entry[e.key].block||{}){i=n[r];t.push(i)}return t}().map(function(n){return n.init()});return Promise.all(n).then(function(){return s.entry[e.key].formmgr.value(e.value)}).then(function(){if(s.onchange){return s.onchange({formmgr:s.entry[e.key].formmgr})}})})}else{o=undefined;a=function(){var n,t=[];for(r in n=s.entry[o].block||{}){i=n[r];t.push(i)}return t}().map(function(n){return n.init()});return Promise.all(a).then(function(){return s.entry[o].formmgr.value(s.data.object)}).then(function(){if(s.onchange){return s.onchange({formmgr:s.entry[o].formmgr})}})}});n=function(n){var f,t,e,r,i;f=function(){return u.value(s.mode==="list"?{list:s.data.list}:{object:s.data.object})};t={add:function(){var n;n=s.data.list;n.push({value:{},key:Math.random().toString(36).substring(2),idx:n.length+1});f();s.view.render();if(s.instance&&s.instance.transform){return s.instance.transform("i18n")}},delete:function(n){var t,e,r,i;t=n.node,e=n.ctx,r=n.ctxs;i=s.data.list;i.splice(i.indexOf(e),1);i.map(function(n,t){return n.idx=t+1});delete s.entry[e.key];f();return s.view.render()},"no-entry":function(n){var t;t=n.node;return t.classList.toggle("d-none",u.content().length)},entry:{init:{"@":function(n){var t,e,r,i,o,a;t=n.ctx,e=n.views;s.entry[t.key]={fields:{},block:{},formmgr:r=new c.manager,cond:new condctrl};for(i in o=s.fields){a=o[i];s.entry[t.key].fields[i]=import$({},a)}s.entry[t.key].cond.list=s.conditions||[];s.entry[t.key].cond.init({fields:s.entry[t.key].fields});r.mode(u.mode());debounce(350).then(function(){s.entry[t.key].cond.run();return e[0].render()});r.on("change",function(){var n;s.entry[t.key].cond.run();e[0].render();if(s.mode==="list"){if(!(n=s.data.list.filter(function(n){return n.key===t.key})[0])){return}n.value=JSON.parse(JSON.stringify(r.value()))}else{s.data.object=JSON.parse(JSON.stringify(r.value()))}return f()});u.fire("manager.changed");console.log("i18n");if(s.instance&&s.instance.transform){return s.instance.transform("i18n")}},block:function(n){var e,t,r,i,o,a,f,c;e=n.node,t=n.ctxs,r=n.ctx;i=s.entry[r.key];o=e.dataset.name;try{if(!s.fields[o]||!(a=JSON.parse(JSON.stringify(s.fields[o])))){throw new Error("config not found for field "+o)}}catch(n){f=n;console.warn("exception when parsing block data for field name `"+o+"`.");throw f}if(!a.meta.title){a.meta.title=o}i.block[o]={cfg:a,path:o,inited:false,init:proxise(function(){if(this.inited){return Promise.resolve()}})};e.classList.toggle("d-none",true);c=typeof a.type==="object"?a.type:typeof a.type==="string"?{name:a.type,version:"main"}:{name:"@makeform/input",version:"main"};return l.from(c,{root:e,data:a.meta}).then(function(n){var t;a.itf=n["interface"];a.bi=n.instance;a.root=e;t=i.fields[o];t.itf=n["interface"];t.bi=n.instance;t.root=e;n["interface"].adapt((t=import$({},s.host),t.upload=function(n){var t,e,r;t=n.file,e=n.progress,r=n.alias;return s.host.upload({file:t,progress:e,alias:r||o})},t));i.formmgr.add({widget:a.itf,path:o});a.itf.mode(i.formmgr.mode());i.block[o].inited=true;i.block[o].init.resolve(true);if(n["interface"].manager().length){u.fire("manager.changed")}return n["interface"].on("manager.changed",function(){return u.fire("manager.changed")})})["catch"](function(n){return Promise.reject(n)})}},handler:{"@":function(n){var t,e;t=n.node,e=n.ctx;if(s.display!=="active"){return}return t.classList.toggle("d-none",e.key!==s.activeKey)},visibility:function(n){var t,e,r,i;t=n.node,e=n.ctx;r=t.getAttribute("data-name");t.classList.toggle("d-none",false);i=(s.entry[e.key]||{}).cond._visibility[r];return t.classList.toggle("d-none",i!=null&&!i)},block:function(n){var t,e,r,i,o,a;t=n.node,e=n.ctxs,r=n.ctx;i=t.getAttribute("data-name");o=(((s.entry[r.key]||{}).block||{})[i]||{}).cfg||{};t.classList.toggle("d-none",false);a=(s.entry[r.key]||{}).cond._visibility[i];return t.classList.toggle("d-none",a!=null&&!a)}}}};e=(r=import$({},n.common||{}),r.initRender=false,r.root=o,r.ctx=function(){return s.data.object},r);if(s.mode==="list"){((r=e.action||(e.action={})).click||(r.click={})).add=t.add;(e.handler||(e.handler={}))["no-entry"]=t["no-entry"];(e.handler||(e.handler={})).entry={list:function(){return s.data.list||[]},key:function(n){return n.key},view:import$({},n.entry||{})};i=e.handler.entry.view;((r=i.action||(i.action={})).click||(r.click={}))["delete"]=t["delete"];import$(i.init||(i.init={}),t.entry.init);import$(i.handler||(i.handler={}),t.entry.handler)}else{import$(e.init||(e.init={}),t.entry.init);import$(e.handler||(e.handler={}),t.entry.handler)}return e};s.init=proxise.once(function(){if(s.inited){return}s.inited=true;if(!s.fields){return}s.view=new f(n(s.viewcfg));return s.view.init().then(function(){return s.view.render()})});return s.init()},render:function(){if(s.view){return s.view.render()}},isEqual:function(n,t){return JSON.stringify(n)===JSON.stringify(t)},isEmpty:function(n){if(s.mode==="list"){return!n||JSON.stringify(n)==="{}"||!n.list||!n.list.length}return!n||JSON.stringify(n)==="{}"},content:function(){if(s.mode==="list"){return s.data.list}else{return s.data.object}},validate:function(u){var n,e,r;u==null&&(u={});n=function(){var n,t=[];for(e in n=s.entry||{}){r=n[e];t.push(r)}return t}().map(function(c){var e,r;return Promise.all(function(){var n,t=[];for(e in n=c.block){r=n[e];t.push(r)}return t}().map(function(){return r.init()})).then(function(n){var t,e,r,i,o,a,f;t=n.filter(function(n){return n}).length||u.init;r=[];for(i in o=c.block){a=o[i];r.push(a)}e=r;f=e.filter(function(n){return n.cfg.itf&&(!n.cfg.itf.isEmpty()||n.cfg.itf.status()===2)&&!n.cfg.itf.disabled()}).map(function(n){return{widget:n.cfg.itf,path:n.path}});if(!f.length&&!u.force){c.status=1;return c}f=u.force?null:f;return c.formmgr.check(f,{now:true,init:t,force:u.force}).then(function(n){c.status=n.length?2:t||f&&f.length<e.length?1:0;return c})})});return Promise.all(n).then(function(n){var e;e=[0,0,0];n.forEach(function(n){return e[n.status]++});if(e[2]){return["nested"]}return Promise.resolve().then(function(){if(!s.validate){return}return s.validate(u,s)}).then(function(n){var t;if(t=n){return t}if(e[1]){return{status:3,errors:[]}}return[]})})},adapt:function(n){return s.host=n},manager:function(n){var t,e,r,i,o,a,f,c;t=function(){var n,t=[];for(e in n=s.entry||{}){r=n[e];t.push(r)}return t}().map(function(n){return n.formmgr}).filter(function(n){return n});for(e in i=s.entry){r=i[e];for(o in a=r.block){f=a[o];if(f.cfg.itf&&(c=f.cfg.itf.manager()).length){t=t.concat(c)}}}return t},ctrl:function(){return{toggle:function(n){n==null&&(n={});if(n.key){s.activeKey=n.key}return s.view.render()}}}}};function in$(n,t){var e=-1,r=t.length>>>0;while(++e<r)if(n===t[e])return true;return false}function import$(n,t){var e={}.hasOwnProperty;for(var r in t)if(e.call(t,r))n[r]=t[r];return n}</script></div>
